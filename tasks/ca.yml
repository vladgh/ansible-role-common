---
# Add extra CA Certificates
- name: Install ca-certificates package (Debian/Ubuntu)
  apt:
    name: ca-certificates
    state: present
  when: ansible_os_family == "Debian"
  register: task_result
  until: task_result is success
  retries: 10
  delay: 2

- name: Install ca-certificates package (RedHat/CentOS)
  yum:
    name: ca-certificates
    state: present
  when: ansible_os_family == "RedHat"
  register: task_result
  until: task_result is success
  retries: 10
  delay: 2

- name: Ensure local certs directory exists
  file:
    state: directory
    path: "{{ ca_path[ansible_os_family] }}/"

- name: Install CA Certificates
  copy:
    src: "{{ item }}"
    dest: "{{ ca_path[ansible_os_family] }}/"
    owner: root
    group: root
    mode: 0644
  with_fileglob:
    - ca/*
  notify:
    - Update trusted CA certificates (Debian/Ubuntu)
    - Update trusted CA certificates (RedHat/CentOS)
  register: install_result

- name: Enable dynamic CA configuration on RedHat/CentOS < 7
  shell: update-ca-trust enable
  when: install_result | changed and ansible_os_family == "RedHat" and ansible_distribution_major_version|int < 7

- name: Enable dynamic CA configuration on RedHat/CentOS >= 7
  shell: update-ca-trust
  when: install_result | changed and ansible_os_family == "RedHat" and ansible_distribution_major_version|int >= 7
